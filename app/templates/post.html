{# app/templates/post.html - STARTING VERSION #}
{% extends "base.html" %}


{# ===== Added recursive comment loading for nested comments ==== #}
{% macro render_comments(comments, reply_form, post, current_user, level=0) %}
    {% for comment in comments %}
        <div class="comment-thread" style="margin-left: {{ level * 25 }}px;">
            <div class="comment border-bottom pb-2 mb-3 {% if comment.commenter.is_admin %}admin-comment{% endif %}" id="comment-{{ comment.id }}">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <div>
                        <strong>{{ comment.commenter.username }}</strong>
                        <small class="text-muted ms-2">{{ comment.timestamp.strftime('%B %d, %Y') }}</small>
                    </div>
                    {% if current_user.is_authenticated %}
                    <div>
                        <button class="btn btn-sm btn-outline-secondary py-0 px-1 reply-btn" data-comment-id="{{ comment.id }}">Reply</button>
                        {% if current_user == comment.commenter or current_user.is_admin %}
                        <a href="{{ url_for('main.edit_comment', comment_id=comment.id) }}" class="btn btn-sm btn-outline-secondary py-0 px-1 ms-1">Edit</a>
                        <form action="{{ url_for('main.delete_comment', comment_id=comment.id) }}" method="POST" class="d-inline ms-1">
                            {{ comment_form.hidden_tag() }}
                            <input type="submit" class="btn btn-sm btn-outline-danger py-0 px-1" value="Delete" onclick="return confirm('Are you sure?');">
                        </form>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                <p class="mb-0">{{ comment.body }}</p>
            </div>

            <div id="reply-form-{{ comment.id }}" class="reply-form-container" style="display: none;">
                <form method="POST" action="{{ url_for('main.post', slug=post.slug) }}">
                    {{ reply_form.hidden_tag() }}
                    {{ reply_form.parent_id(value=comment.id) }}
                    <div class="form-floating mb-2">
                        {{ reply_form.body(class="form-control form-control-sm", placeholder="Your Reply", rows="3") }}
                        {{ reply_form.body.label }}
                    </div>
                    {{ reply_form.submit(class="btn btn-sm btn-primary") }}
                </form>
            </div>

            {% if comment.replies %}
                {{ render_comments(comment.replies.all(), reply_form, post, current_user, level + 1) }}
            {% endif %}
        </div>
    {% endfor %}
{% endmacro %}

{% block content %}
    <article class="media content-section">
        <div class="media-body">
            <div class="article-metadata">
                <a class="mr-2" href="#">{{ post.author.username }}</a> {# Link to user profile later? #}
                <small class="text-muted">{{ post.timestamp.strftime('%Y-%m-%d %H:%M') }} UTC</small>
                 {% if current_user.is_authenticated and current_user.is_admin %}
                    {# Admin Edit/Delete Links #}
                    <div class="float-end">
                         {# NOTE: This edit link will need to change for slugs later #}
                         <a class="btn btn-secondary btn-sm mt-1 mb-1" href="{{ url_for('main.edit_post', post_id=post.id) }}">Edit</a>
                         {# Delete needs a form for CSRF protection #}
                         <form action="{{ url_for('main.delete_post', post_id=post.id) }}" method="POST" style="display: inline;">
                            {# NOTE: This delete form action will need to change for slugs later #}
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="submit" class="btn btn-danger btn-sm" value="Delete" onclick="return confirm('Are you sure you want to delete this post?');">
                         </form>
                    </div>
                 {% endif %}
            </div>

                <div class="mb-3">
                {% set post_url = url_for('main.post', slug=post.slug, _external=True) %}
                <a href="https://twitter.com/intent/tweet?url={{ post_url }}&text={{ post.title|urlencode }}" target="_blank" class="btn btn-outline-secondary btn-sm" title="Share on X">X (Twitter)</a>
                <a href="https://www.facebook.com/sharer/sharer.php?u={{ post_url }}" target="_blank" class="btn btn-outline-secondary btn-sm" title="Share on Facebook">Facebook</a>
                <a href="https://www.reddit.com/submit?url={{ post_url }}&title={{ post.title|urlencode }}" target="_blank" class="btn btn-outline-secondary btn-sm" title="Share on Reddit">Reddit</a>
                <a href="mailto:?subject={{ post.title|urlencode }}&body=Check out this article: {{ post_url }}" class="btn btn-outline-secondary btn-sm" title="Share via Email">Email</a>
            </div>

            <h2 class="article-title">{{ post.title }}</h2>
                {% if post.image_url %}
                <div class="post-image mb-3 text-center"> {# Add some margin #}
             {# Example Cloudinary Transformation: limit width to 800px, auto format/quality #}
             {# Construct URL manually or use Cloudinary Python helpers if needed #}
             {% set transformed_url = post.image_url.replace('/upload/', '/upload/w_800,f_auto,q_auto/') %}
                    <img src="{{ transformed_url }}" class="img-fluid rounded" alt="{{ post.title }} featured image"> {# Bootstrap classes #}
                </div>
            {% endif %}

                <div class="article-content">{{ post.body | safe }}</div>

            </div>

            </article>

        {# TAG DISPLAY BLOCK HERE #}
    <div class="post-tags mt-3 mb-3"> {# Added margin bottom #}
        <strong>Tags:</strong>
        {% if post.tags %}
            {% for tag in post.tags %}
                {# Link each tag to its dedicated page #}
                <a href="{{ url_for('main.tag', tag_name=tag.name) }}" class="badge bg-secondary text-decoration-none me-1">{{ tag.name }}</a>
            {% endfor %}
        {% else %}
            <span class="text-muted">No tags assigned.</span>
        {% endif %}
    </div>
    {# END TAG DISPLAY BLOCK #}

    </article> {# TAG DISPLAY BLOCK HERE #}
        {% if related_posts %}
    <div class="content-section mt-4">
        <h3 class="mb-4">You Might Also Like</h3>
        <div class="row">
            {% for r_post in related_posts %}
                <div class="col-md-4 mb-3">
                    <div class="card h-100 shadow-sm">
                        {% if r_post.image_url %}
                            {% set thumb_url = r_post.image_url.replace('/upload/', '/upload/w_300,h_200,c_fill,g_auto,f_auto,q_auto/') %}
                            <a href="{{ url_for('main.post', slug=r_post.slug) }}">
                                <img src="{{ thumb_url }}" class="card-img-top" alt="{{ r_post.title }} thumbnail">
                            </a>
                        {% endif %}
                        <div class="card-body">
                            <h5 class="card-title">
                                <a class="article-title" href="{{ url_for('main.post', slug=r_post.slug) }}">{{ r_post.title }}</a>
                            </h5>
                            <small class="text-muted">{{ r_post.published_at.strftime('%B %d, %Y') }}</small>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {# Comments Section #}
    <div class="content-section mt-4">
        <h3>Comments</h3>
        <hr>
        {# Comment Form #}
         {% if current_user.is_authenticated %}
            <form method="POST" action=""> {# Submits to the current post URL #}
                {{ comment_form.hidden_tag() }} {# CSRF token #}
                <fieldset class="form-group mb-3">
                    <div class="form-floating">
                         {{ comment_form.body(class="form-control" + (" is-invalid" if comment_form.body.errors else ""), style="height: 100px", placeholder="Leave a comment here") }}
                         {{ comment_form.body.label(class="form-label") }}
                         {% if comment_form.body.errors %}
                            <div class="invalid-feedback">
                                {% for error in comment_form.body.errors %}
                                    <span>{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </fieldset>
                <div class="form-group mb-3">
                    {{ form.submit(class="btn btn-outline-info") }}
                </div>
            </form>
        {% else %}
             {# NOTE: This login link will need to change for slugs later #}
            <p><a href="{{ url_for('main.login', next=url_for('main.post', slug=post.slug)) }}">Log in</a> to post a comment.</p>
        {% endif %}

        {# Display Existing Comments with Edit/Delete Functionality #}{# Display Existing Comments #}
        {#{% if comments %}
            {#    {{ render_comments(comments, reply_form, post, current_user) }}
            {#{% else %}
            {#     <p class="text-muted">No comments yet. Be the first to comment!</p>
            {#{% endif %}
    </div>

{% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const replyButtons = document.querySelectorAll('.reply-btn');
            replyButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const commentId = this.getAttribute('data-comment-id');
                    const replyFormContainer = document.getElementById(`reply-form-${commentId}`);

                    // Hide all other open reply forms
                    document.querySelectorAll('.reply-form-container').forEach(form => {
                        if (form.id !== `reply-form-${commentId}`) {
                            form.style.display = 'none';
                        }
                    });

                    // Toggle clicked form
                    if (replyFormContainer) {
                        replyFormContainer.style.display = (replyFormContainer.style.display === 'none') ? 'block' : 'none';
                    }
                });
            });
        });
    </script>

{% endblock %}
