<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-t">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="csrf-token" content="{{ csrf_token() }}">

    {# --- Anti-Flicker Theme Script (Executes First) --- #}
    <script>
      (() => {
        const getStoredTheme = () => localStorage.getItem('theme');
        const getPreferredTheme = () => {
          const storedTheme = getStoredTheme();
          if (storedTheme) return storedTheme;
          return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        };
        document.documentElement.setAttribute('data-bs-theme', getPreferredTheme());
      })();
    </script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Source+Sans+3:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">

    {# --- Custom Stylesheet (Cache-Busted) --- #}
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css', v=css_version) }}">

    {# --- Favicon Links --- #}
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">

    {% if title %}
        <title>{{ title }} - {{ config.get('BLOG_NAME', 'Fragrance Blog') }}</title>
    {% else %}
        <title>{{ config.get('BLOG_NAME', 'Fragrance Blog') }}</title>
    {% endif %}

    {# --- RSS Feed Link --- #}
    <link rel="alternate" type="application/rss+xml" title="{{ config.get('BLOG_NAME', 'Fragrance Blog') }} RSS Feed" href="{{ url_for('main.rss_feed', _external=True) }}">

    {# --- Google Analytics Script (Conditionally Loaded) --- #}
    {% if request.cookies.get('cookie_consent') == 'true' %}
        {% if config.get('GOOGLE_ANALYTICS_ID') %}
        <script async src="https://www.googletagmanager.com/gtag/js?id={{ config.get('GOOGLE_ANALYTICS_ID') }}"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', '{{ config.get('GOOGLE_ANALYTICS_ID') }}');
        </script>
        {% endif %}
    {% endif %}

    <style>
      .cookie-consent-banner {
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          background-color: var(--navbar-bg, #212529);
          color: var(--text-color-light, #f8f9fa);
          padding: 1rem;
          z-index: 1050;
          box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
      }
      .cookie-consent-banner p {
          font-size: 0.9rem;
          margin-right: 1rem;
          margin-bottom: 0;
      }
      .cookie-consent-banner a {
          color: var(--link-color, #D4AF37);
          text-decoration: underline;
      }
    </style>
    </head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4 shadow-sm fixed-top">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('main.index') }}">{{ config.get('BLOG_NAME', 'Fragrance Blog') }}</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
             <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0"></ul>
                <form class="d-flex my-2 my-lg-0 me-lg-3" method="GET" action="{{ url_for('main.search') }}" role="search">
                  <input class="form-control me-2" type="search" placeholder="Search Posts" aria-label="Search" name="q" value="{{ request.args.get('q', '') }}">
                  <button class="btn btn-outline-light" type="submit">Search</button>
                </form>
                <ul class="navbar-nav">
                     {% if current_user.is_authenticated %}
                         {% if current_user.is_admin %}
                             <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Admin</a>
                                <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="adminDropdown">
                                  <li><a class="dropdown-item" href="{{ url_for('main.admin_dashboard') }}">Dashboard</a></li>
                                  <li><a class="dropdown-item" href="{{ url_for('main.create_post') }}">New Post</a></li>
                                  <li><a class="dropdown-item" href="{{ url_for('main.admin_account') }}">My Account</a></li>
                                </ul>
                              </li>
                        {% endif %}

                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                Hi, {{ current_user.username }}!
                            </a>
                            <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="userDropdown">
                                <li><a class="dropdown-item" href="{{ url_for('main.logout') }}">Logout</a></li>
                            </ul>
                        </li>

                    {% else %}
                         <li class="nav-item">
                            <a class="nav-link {% if request.endpoint == 'main.login' %}active{% endif %}" href="{{ url_for('main.login') }}">Sign In</a>
                        </li>
                    {% endif %}
                    <li class="nav-item ms-lg-2"><button class="btn btn-outline-light" id="theme-toggler" type="button" aria-label="Toggle theme"></button></li>
                </ul>
            </div>
        </div>
    </nav>

    <main role="main" class="container">
        <div class="row">
            <div class="col-md-8">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category if category != 'message' else 'info' }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                {% block content %}{% endblock %}
            </div>

            <div class="col-md-4">
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-light"><h4 class="mb-0">Recent Posts</h4></div>
                    <div class="list-group list-group-flush">
                        {% if sidebar_recent_posts %}
                            {% for r_post in sidebar_recent_posts %}
                                <a href="{{ url_for('main.post', slug=r_post.slug) }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-start">
                                    <div class="ms-2 me-auto">
                                        <div class="fw-bold">{{ r_post.title | truncate(40, True) }}</div>
                                        <small class="text-muted">By {{ r_post.author.username }}</small>
                                    </div>
                                    <span class="badge bg-primary rounded-pill">{{ r_post.timestamp.strftime('%b %d') }}</span>
                                </a>
                            {% endfor %}
                        {% else %}
                            <li class="list-group-item text-muted">No recent posts to display.</li>
                        {% endif %}
                    </div>
                </div>
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-light"><h4 class="mb-0">Popular Tags</h4></div>
                    <div class="card-body">
                        {% if sidebar_popular_tags %}
                            {% for s_tag in sidebar_popular_tags %}
                                <a href="{{ url_for('main.tag', tag_name=s_tag.name) }}" class="btn btn-sm btn-outline-secondary me-1 mb-2">{{ s_tag.name }}</a>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted mb-0">No tags available yet.</p>
                        {% endif %}
                    </div>
                </div>
                <div class="card shadow-sm">
                     <div class="card-header bg-light"><h4 class="mb-0">About This Blog</h4></div>
                    <div class="card-body">
                        <p class='text-muted'>Welcome to my fragrance journey! Discover reviews, thoughts, and explorations into the captivating world of scents.</p>
                        <p class="mt-3">
                            <a href="{{ url_for('main.rss_feed', _external=True) }}" target="_blank" rel="noopener noreferrer" class="text-decoration-none">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-rss-fill me-1" viewBox="0 0 16 16">
                                  <path d="M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zm1.5 2.5c5.523 0 10 4.477 10 10H11.5a7.5 7.5 0 0 0-7.5-7.5zM2.5 8a5 5 0 0 1 5 5H6a3.5 3.5 0 0 0-3.5-3.5zM3 12a1 1 0 1 1 2 0 1 1 0 0 1-2 0"/>
                                </svg>
                                Subscribe to RSS Feed
                            </a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="cookie-consent-banner" class="cookie-consent-banner" style="display: none;">
        <div class="container d-flex justify-content-between align-items-center flex-wrap">
            <p class="flex-grow-1">
                We use cookies to enhance your experience and analyze site traffic. By clicking "Accept," you agree to our use of cookies.
                <a href="{{ url_for('main.privacy_policy') }}">Learn more</a>.
            </p>
            <div class="flex-shrink-0">
                <button id="btn-cookie-decline" class="btn btn-sm btn-outline-light">Decline</button>
                <button id="btn-cookie-accept" class="btn btn-sm btn-primary ms-2">Accept</button>
            </div>
        </div>
    </div>
    <footer class="container mt-5 py-3 border-top text-center">
        <div class="row justify-content-center mb-4">
            <div class="col-md-6">
                <h5>Subscribe to Liquid Blossom</h5>
                <p class="text-muted">Get the latest reviews and articles delivered straight to your inbox.</p>
                <form action="{{ url_for('main.subscribe') }}" method="POST" class="d-flex" novalidate>
                    {{ subscription_form.hidden_tag() }}
                    <div class="form-floating flex-grow-1">
                        {{ subscription_form.email(class="form-control", placeholder="Your Email Address") }}
                        {{ subscription_form.email.label }}
                    </div>
                    {{ subscription_form.submit(class="btn btn-primary ms-2") }}
                </form>
            </div>
        </div>
        <p class="text-muted">© {{ now().year }} {{ config.get('BLOG_NAME', 'Fragrance Blog') }}. All Rights Reserved.
            <a href="{{ url_for('main.contact') }}" class="ms-3">Contact</a>
            <a href="{{ url_for('main.privacy_policy') }}" class="ms-3">Privacy Policy</a>
        </p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

    {# --- Theme Toggler Logic --- #}
    <script>
      (() => {
        // ... your existing theme toggler script ...
        'use strict'
        const themeToggler = document.querySelector('#theme-toggler');
        const getStoredTheme = () => localStorage.getItem('theme');
        const setStoredTheme = theme => localStorage.setItem('theme', theme);
        const setThemeIcon = () => {
          if (themeToggler) {
            const currentTheme = document.documentElement.getAttribute('data-bs-theme');
            themeToggler.innerHTML = (currentTheme === 'dark') ? '☀️' : '🌙';
          }
        }
        window.addEventListener('DOMContentLoaded', () => {
          setThemeIcon();
          if (themeToggler) {
            themeToggler.addEventListener('click', () => {
              const currentTheme = getStoredTheme() || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
              const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
              setStoredTheme(newTheme);
              document.documentElement.setAttribute('data-bs-theme', newTheme);
              setThemeIcon();
            });
          }
        });
      })()
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        'use strict';

        const banner = document.getElementById('cookie-consent-banner');
        const acceptBtn = document.getElementById('btn-cookie-accept');
        const declineBtn = document.getElementById('btn-cookie-decline');

        const getCookie = (name) => {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        };

        if (!getCookie('cookie_consent')) {
            banner.style.display = 'block';
        }

        const setConsent = (consent) => {
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            fetch('/set-cookie-consent', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ consent: consent.toString() })
            })
            .then(response => {
                if (!response.ok) {
                    console.error('Failed to set cookie consent.');
                }
                banner.style.display = 'none';
                if (consent === true) {
                    location.reload();
                }
            })
            .catch(error => console.error('Error setting cookie consent:', error));
        };

        acceptBtn.addEventListener('click', () => setConsent(true));
        declineBtn.addEventListener('click', () => setConsent(false));
    });
    </script>
    </body>
</html>
